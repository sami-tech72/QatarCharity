<ng-container *ngIf="!loading && contract; else loadingStateTpl">
  <!--begin::Content-->
  <div id="kt_app_content" class="app-content flex-column-fluid">
    <!--begin::Content container-->
    <div id="kt_app_content_container" class="app-container container-xxl">
      <!--begin::Invoice 2 main-->
      <div class="card">
        <!--begin::Body-->
        <div class="card-body p-lg-20">
          <!--begin::Layout-->
          <div class="d-flex flex-column flex-xl-row">
            <!--begin::Content-->
            <div class="flex-lg-row-fluid me-xl-18 mb-10 mb-xl-0">
              <!--begin::Invoice 2 content-->
              <div class="mt-n1">
                <!--begin::Top-->
                <div class="d-flex flex-stack pb-10">
                  <!--begin::Logo-->
                  <a href="#">
                    <img alt="Logo" src="assets/media/logos/qc_logo.png" />
                  </a>
                  <!--end::Logo-->
                  <!--begin::Action-->
                  <span class="badge" [ngClass]="statusClass">{{ statusBadge }}</span>
                  <!--end::Action-->
                </div>
                <!--end::Top-->
                <!--begin::Wrapper-->
                <div class="m-0">
                  <!--begin::Label-->
                  <div class="fw-bold fs-3 text-gray-800 mb-8">Invoice #{{ referenceNumber }}</div>
                  <!--end::Label-->
                  <div class="row g-4 mb-10 detail-card-grid">
                    <div class="col-sm-6 col-lg-3">
                      <div class="detail-card h-100">
                        <div class="detail-label">Issue Date</div>
                        <div class="detail-value">{{ formatDate(createdDate) }}</div>
                      </div>
                    </div>
                    <div class="col-sm-6 col-lg-3">
                      <div class="detail-card h-100">
                        <div class="detail-label">Due Date</div>
                        <div class="detail-value">{{ formatDate(endDate) }}</div>
                      </div>
                    </div>
                    <div class="col-sm-6 col-lg-3">
                      <div class="detail-card h-100">
                        <div class="detail-label">Contract Value</div>
                        <div class="detail-value">{{ totals.total | currency: currency }}</div>
                      </div>
                    </div>
                    <div class="col-sm-6 col-lg-3">
                      <div class="detail-card h-100">
                        <div class="detail-label">Status</div>
                        <div class="detail-value d-flex align-items-center gap-2 flex-wrap">
                          <span class="badge" [ngClass]="statusClass">{{ statusBadge }}</span>
                          <span class="text-muted fw-semibold">{{ contract.status }}</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="row g-5 mb-12">
                    <div class="col-lg-6">
                      <div class="contact-card h-100">
                        <div class="card-label">Issue For</div>
                        <div class="card-title">{{ contract.supplier.companyName }}</div>
                        <div class="card-meta">
                          {{ contract.supplier.companyAddress || 'Address not provided' }}
                        </div>
                        <div class="card-meta">
                          {{ contract.supplier.contactName || 'Contact N/A' }} · {{ contract.supplier.contactEmail || 'Email N/A' }}
                        </div>
                      </div>
                    </div>
                    <div class="col-lg-6">
                      <div class="contact-card h-100">
                        <div class="card-label">Issued By</div>
                        <div class="card-title">{{ contract.issuerCompany.name }}</div>
                        <div class="card-meta">{{ contract.issuerCompany.address }}</div>
                        <div class="card-meta">
                          {{ contract.issuerCompany.contactPhone }} · {{ contract.issuerCompany.contactEmail }}
                        </div>
                      </div>
                    </div>
                  </div>
                  <!--begin::Content-->
                  <div class="flex-grow-1">
                    <!--begin::Table-->
                    <div class="table-responsive border-bottom mb-9">
                      <table class="table mb-3">
                        <thead>
                          <tr class="border-bottom fs-6 fw-bold text-muted">
                            <th class="min-w-175px pb-2">Description</th>
                            <th class="min-w-70px text-end pb-2">Qty</th>
                            <th class="min-w-80px text-end pb-2">Rate</th>
                            <th class="min-w-100px text-end pb-2">Amount</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr class="fw-bold text-gray-700 fs-5 text-end" *ngFor="let item of lineItems">
                            <td class="d-flex align-items-center pt-6">
                              <i class="fa fa-genderless text-danger fs-2 me-2"></i>{{ item.name }}</td>
                            <td class="pt-6">{{ item.quantity }}</td>
                            <td class="pt-6">{{ item.rate | currency: currency }}</td>
                            <td class="pt-6 text-dark fw-bolder">{{ item.total | currency: currency }}</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                    <!--end::Table-->
                    <!--begin::Container-->
                    <div class="d-flex justify-content-end">
                      <!--begin::Section-->
                      <div class="mw-300px">
                        <!--begin::Item-->
                        <div class="d-flex flex-stack mb-3">
                          <!--begin::Accountname-->
                          <div class="fw-semibold pe-10 text-gray-600 fs-7">Subtotal:</div>
                          <!--end::Accountname-->
                          <!--begin::Label-->
                          <div class="text-end fw-bold fs-6 text-gray-800">{{ totals.subtotal | currency: currency }}</div>
                          <!--end::Label-->
                        </div>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <div class="d-flex flex-stack mb-3">
                          <!--begin::Accountname-->
                          <div class="fw-semibold pe-10 text-gray-600 fs-7">VAT 0%</div>
                          <!--end::Accountname-->
                          <!--begin::Label-->
                          <div class="text-end fw-bold fs-6 text-gray-800">{{ totals.tax | currency: currency }}</div>
                          <!--end::Label-->
                        </div>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <div class="d-flex flex-stack mb-3">
                          <!--begin::Accountnumber-->
                          <div class="fw-semibold pe-10 text-gray-600 fs-7">Subtotal + VAT</div>
                          <!--end::Accountnumber-->
                          <!--begin::Number-->
                          <div class="text-end fw-bold fs-6 text-gray-800">{{ (totals.subtotal + totals.tax) | currency: currency }}</div>
                          <!--end::Number-->
                        </div>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <div class="d-flex flex-stack">
                          <!--begin::Code-->
                          <div class="fw-semibold pe-10 text-gray-600 fs-7">Total</div>
                          <!--end::Code-->
                          <!--begin::Label-->
                          <div class="text-end fw-bold fs-6 text-gray-800">{{ totals.total | currency: currency }}</div>
                          <!--end::Label-->
                        </div>
                        <!--end::Item-->
                      </div>
                      <!--end::Section-->
                    </div>
                    <!--end::Container-->
                    <div class="mt-10">
                      <h6 class="mb-4 fw-bolder text-gray-600 text-hover-primary">Signatures</h6>
                      <div class="row g-5">
                        <div class="col-sm-6">
                          <div class="fw-semibold text-gray-600 fs-7 mb-2">Supplier Signature</div>
                          <ng-container *ngIf="contract.supplierSignature; else supplierPending">
                            <img
                              *ngIf="isImageSignature(contract.supplierSignature)"
                              [src]="contract.supplierSignature"
                              alt="Supplier signature"
                              class="img-fluid"
                            />
                            <div *ngIf="!isImageSignature(contract.supplierSignature)">{{ contract.supplierSignature }}</div>
                            <div class="text-muted fs-8">Signed on {{ formatDate(contract.supplierSignedAtUtc) }}</div>
                          </ng-container>
                          <ng-template #supplierPending>
                            <div class="text-muted fs-8">Awaiting supplier signature</div>
                          </ng-template>
                        </div>
                        <div class="col-sm-6">
                          <div class="fw-semibold text-gray-600 fs-7 mb-2">Issuer Signature</div>
                          <div class="text-muted fs-8">Not captured</div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <!--end::Content-->
                </div>
                <!--end::Wrapper-->
              </div>
              <!--end::Invoice 2 content-->
            </div>
            <!--end::Content-->
            <!--begin::Sidebar-->
            <div class="m-0">
              <!--begin::Invoice 2 sidebar-->
              <div class="d-print-none border border-dashed border-gray-300 card-rounded h-lg-100 min-w-md-350px p-9 bg-lighten">
                <!--begin::Labels-->
                <div class="mb-8">
                  <span class="badge badge-light-success me-2">{{ statusBadge }}</span>
                  <span class="badge badge-light-warning">{{ contract.status }}</span>
                </div>
                <!--end::Labels-->
                <!--begin::Title-->
                <h6 class="mb-8 fw-bolder text-gray-600 text-hover-primary">PAYMENT DETAILS</h6>
                <!--end::Title-->
                <!--begin::Item-->
                <div class="mb-6">
                  <div class="fw-semibold text-gray-600 fs-7">Supplier Contact</div>
                  <div class="fw-bold text-gray-800 fs-6">{{ contract.supplier.contactName || 'Not provided' }}</div>
                </div>
                <!--end::Item-->
                <!--begin::Item-->
                <div class="mb-6">
                  <div class="fw-semibold text-gray-600 fs-7">Account:</div>
                  <div class="fw-bold text-gray-800 fs-6">{{ contract.supplier.contactEmail || 'Not provided' }}</div>
                </div>
                <!--end::Item-->
                <!--begin::Item-->
                <div class="mb-15">
                  <div class="fw-semibold text-gray-600 fs-7">Payment Term:</div>
                  <div class="fw-bold fs-6 text-gray-800 d-flex align-items-center">{{ formatDate(endDate) }}</div>
                </div>
                <!--end::Item-->
                <!--begin::Title-->
                <h6 class="mb-8 fw-bolder text-gray-600 text-hover-primary">PROJECT OVERVIEW</h6>
                <!--end::Title-->
                <!--begin::Item-->
                <div class="mb-6">
                  <div class="fw-semibold text-gray-600 fs-7">Project Name</div>
                  <div class="fw-bold fs-6 text-gray-800">{{ contract.title }}</div>
                </div>
                <!--end::Item-->
                <!--begin::Item-->
                <div class="mb-6">
                  <div class="fw-semibold text-gray-600 fs-7">Supplier</div>
                  <div class="fw-bold text-gray-800 fs-6">{{ supplierName }}</div>
                </div>
                <!--end::Item-->
                <!--begin::Item-->
                <div class="m-0">
                  <div class="fw-semibold text-gray-600 fs-7">Timeline</div>
                  <div class="fw-bold fs-6 text-gray-800 d-flex align-items-center">
                    {{ formatDate(startDate) }} - {{ formatDate(endDate) }}
                  </div>
                </div>
                <!--end::Item-->
              </div>
              <!--end::Invoice 2 sidebar-->
            </div>
            <!--end::Sidebar-->
          </div>
          <!--end::Layout-->
        </div>
        <!--end::Body-->
      </div>
      <!--end::Invoice 2 main-->
    </div>
    <!--end::Content container-->
  </div>
  <!--end::Content-->
</ng-container>

<ng-template #loadingStateTpl>
  <div class="card loading">
    <p *ngIf="!missingContractMessage">Loading contract details...</p>
    <p *ngIf="missingContractMessage">{{ missingContractMessage }}</p>
  </div>
</ng-template>