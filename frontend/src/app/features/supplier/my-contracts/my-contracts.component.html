<div class="container-fluid" *ngIf="!loading; else loadingState">
  <!-- Page Header -->
  <div class="row mb-5">
    <div class="col-12">
      <h1 class="page-title mb-2">My Contracts</h1>
      <p class="text-muted">View and sign contracts that have been issued to your organization.</p>
    </div>
  </div>

 
  <!-- Contracts Table Section -->
  <div class="card border-0 shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <h5 class="card-title mb-0 fw-bold">All Contracts</h5>
        <div class="search-box" style="width: 300px;">
          <input type="text" class="form-control" placeholder="Search contracts..." (input)="filterContracts($event)" />
        </div>
      </div>

      <div class="table-responsive app-table-wrapper" *ngIf="filteredContracts.length > 0; else emptyState">
        <table class="table app-table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th class="fw-semibold">Reference</th>
              <th class="fw-semibold">Title</th>
              <th class="fw-semibold">Value</th>
              <th class="fw-semibold">Status</th>
              <th class="fw-semibold">Valid From</th>
              <th class="fw-semibold">Valid To</th>
              <th class="fw-semibold text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let contract of filteredContracts">
              <td class="fw-semibold text-primary">{{ contract.referenceNumber || 'Direct' }}</td>
              <td>{{ contract.title }}</td>
              <td>{{ contract.contractValue | currency: contract.currency }}</td>
              <td>
                <span class="badge" [ngClass]="getStatusClass(contract.status)">
                  {{ contract.status }}
                </span>
                <small class="text-muted d-block" *ngIf="contract.supplierSignedAtUtc">
                  Signed {{ contract.supplierSignedAtUtc | date: 'mediumDate' }}
                </small>
              </td>
              <td>{{ contract.startDateUtc | date: 'M/d/y' }}</td>
              <td>{{ contract.endDateUtc | date: 'M/d/y' }}</td>
              <td class="text-end">
                <div class="d-inline-flex justify-content-end align-items-center gap-2">
                  <a class="btn btn-sm btn-light" [routerLink]="['/supplier/my-contracts', contract.id]">View</a>
                  <button
                    class="btn btn-sm btn-primary"
                    [disabled]="!canSign(contract)"
                    (click)="openSignatureModal(contract)"
                    *ngIf="contract.status.toLowerCase() === 'draft'"
                  >
                    {{ signingContractIds.has(contract.id) ? 'Signing…' : 'Sign Contract' }}
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<ng-template #emptyState>
  <div class="text-center py-5">
    <p class="text-muted">No contracts found.</p>
    <p class="text-muted">Once procurement shares a contract with you it will appear here for signature.</p>
  </div>
</ng-template>

<ng-template #loadingState>
  <div class="text-center py-5">
    <p class="text-muted">Loading your contracts…</p>
  </div>
</ng-template>

<div class="signature-backdrop" *ngIf="signatureModalOpen">
  <div class="signature-modal card border-0 shadow-lg">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div>
        <h5 class="mb-0">Sign Contract</h5>
        <small class="text-muted" *ngIf="activeContract">{{ activeContract.title }}</small>
      </div>
      <button class="btn btn-sm btn-outline-secondary" (click)="closeSignatureModal()">&times;</button>
    </div>
    <div class="card-body">
      <p class="text-muted mb-3">Draw your digital signature below to activate the contract.</p>

      <div class="signature-pad border rounded-3 mb-3" (touchmove)="$event.preventDefault()">
        <canvas
          #signatureCanvas
          (mousedown)="startDrawing($event)"
          (mousemove)="drawStroke($event)"
          (mouseup)="finishDrawing()"
          (mouseleave)="finishDrawing()"
          (touchstart)="startDrawing($event)"
          (touchmove)="drawStroke($event)"
          (touchend)="finishDrawing()"
          (touchcancel)="finishDrawing()"
        ></canvas>
      </div>

      <div class="d-flex justify-content-between align-items-center">
        <button class="btn btn-outline-secondary" type="button" (click)="clearSignature()">Clear</button>
        <div class="d-flex gap-2">
          <button class="btn btn-light" type="button" (click)="closeSignatureModal()">Cancel</button>
          <button class="btn btn-primary" type="button" (click)="submitSignature()">
            {{ signingContractIds.has(activeContract?.id || '') ? 'Submitting…' : 'Submit Signature' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
