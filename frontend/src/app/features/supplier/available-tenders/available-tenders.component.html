<div class="available-tenders container-xxl">
  <div class="page-heading d-flex flex-column flex-lg-row align-items-lg-center gap-4">
    <div>
      <h1 class="page-title mb-2">Available Tenders</h1>
      <p class="text-muted mb-0">Browse and bid on available procurement opportunities</p>
    </div>
    <div class="filter-toolbar d-flex flex-column flex-md-row align-items-md-center gap-3 ms-lg-auto">
      <div class="input-group search-input">
        <span class="input-group-text" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24">
            <path
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="m21 21-4.35-4.35M11 19a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z"
            />
          </svg>
        </span>
        <input
          type="text"
          class="form-control"
          placeholder="Search tenders by title, number, or category"
          aria-label="Search tenders by title, number, or category"
          [(ngModel)]="searchTerm"
          (ngModelChange)="onSearch($event)"
          (keyup.enter)="refreshTenders()"
        />
      </div>
      <button type="button" class="btn btn-light" (click)="refreshTenders()">Filter</button>
    </div>
  </div>

  <div class="tenders-meta text-muted" *ngIf="!loading; else loadingMeta">
    Showing {{ tenders.length }} published tenders
  </div>
  <ng-template #loadingMeta>
    <div class="tenders-meta text-muted">Loading published tenders...</div>
  </ng-template>

  <div *ngIf="error" class="alert alert-danger" role="alert">{{ error }}</div>

  <div *ngIf="!loading && !error && tenders.length === 0" class="empty-state">
    <div class="empty-title">No published tenders found</div>
    <p class="text-muted mb-0">Try adjusting your search or check back later for new opportunities.</p>
  </div>

  <div class="tenders-layout" *ngIf="tenders.length > 0">
    <div class="tenders-list">
      <div class="tender-card" *ngFor="let tender of tenders; trackBy: trackByTenderId">
        <div class="tender-content">
          <div class="tender-left">
            <div class="badge-row">
              <span class="badge badge-soft-primary">{{ tender.rfxType }}</span>
              <span class="badge badge-soft-success">{{ getRemainingDays(tender.submissionDeadline) }} days left</span>
            </div>
            <div class="title-row">
              <h2 class="tender-title mb-0">{{ tender.title }}</h2>
              <span class="badge badge-soft-info">{{ tender.category }}</span>
            </div>
            <p class="tender-summary mb-2">{{ tender.description }}</p>
            <div class="tender-reference text-muted fw-semibold">Reference {{ tender.referenceNumber }}</div>
          </div>

          <div class="tender-right">
            <div class="detail-item">
              <div class="detail-label">Submission Deadline</div>
              <div class="detail-value">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24">
                  <path
                    stroke="currentColor"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M7 4V3m10 1V3m-9 8h8m-7 4h3m-2 4h4M3 8.5C3 7.12 4.12 6 5.5 6h13A1.5 1.5 0 0 1 20 7.5v13A1.5 1.5 0 0 1 18.5 22h-13A1.5 1.5 0 0 1 4 20.5V7.5"
                  />
                </svg>
                <span>{{ tender.submissionDeadline | date: 'MM/dd/yyyy' }}</span>
              </div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Budget Range</div>
              <div class="detail-value">{{ formatBudget(tender) }}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Published</div>
              <div class="detail-value">{{ tender.publicationDate | date: 'MM/dd/yyyy' }}</div>
            </div>
            <div class="action-row">
              <button type="button" class="btn btn-outline-secondary" (click)="viewDetails(tender)">View Details</button>
              <button type="button" class="btn btn-success" (click)="startBid(tender)">Open Bid Page</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="tender-details" [class.has-selection]="selectedTender">
      <div *ngIf="selectedTender; else noSelection" class="tender-details__content">
        <div class="detail-header">
          <div>
            <p class="detail-label mb-1">Reference {{ selectedTender.referenceNumber }}</p>
            <h3 class="detail-title mb-1">{{ selectedTender.title }}</h3>
            <p class="text-muted mb-0">{{ selectedTender.description }}</p>
          </div>
        <div class="detail-badges text-end">
          <span class="badge badge-soft-primary me-2">{{ selectedTender.rfxType }}</span>
          <span class="badge badge-soft-info">{{ selectedTender.category }}</span>
          <div class="mt-2">
            <button class="btn btn-sm btn-success" type="button" (click)="goToBid(selectedTender)">
              Open bid submission page
            </button>
          </div>
        </div>
      </div>

      <div class="detail-grid">
        <div>
          <p class="detail-label mb-1">Submission deadline</p>
          <p class="detail-value">{{ selectedTender.submissionDeadline | date: 'fullDate' }}</p>
          </div>
          <div>
            <p class="detail-label mb-1">Closing date</p>
            <p class="detail-value">{{ selectedTender.closingDate | date: 'fullDate' }}</p>
          </div>
          <div>
            <p class="detail-label mb-1">Budget</p>
            <p class="detail-value">{{ formatBudget(selectedTender) }}</p>
          </div>
        </div>

        <div class="requirements-card">
          <div class="requirements-card__header">
            <div>
              <p class="detail-label mb-1">Tender requirements</p>
              <h4 class="mb-0">What is needed for this submission</h4>
            </div>
            <span class="badge badge-soft-secondary">Dynamic from tender</span>
          </div>

          <div class="requirements-grid">
            <div class="requirement requirement--full">
              <p class="requirement-label">Required details</p>
              <ul class="requirement-list" *ngIf="selectedTender.requiredDetails?.length; else noDetails">
                <li *ngFor="let detail of selectedTender.requiredDetails">{{ detail }}</li>
              </ul>
              <ng-template #noDetails>
                <p class="mb-0">No specific detailed requirements provided.</p>
              </ng-template>
            </div>
            <div class="requirement">
              <p class="requirement-label">Scope &amp; summary</p>
              <p class="mb-0">{{ selectedTender.scope || 'No scope provided.' }}</p>
            </div>
            <div class="requirement">
              <p class="requirement-label">Technical specification</p>
              <p class="mb-0">{{ selectedTender.technicalSpecification || 'No technical specification provided.' }}</p>
            </div>
            <div class="requirement">
              <p class="requirement-label">Deliverables</p>
              <p class="mb-0">{{ selectedTender.deliverables || 'No deliverables listed.' }}</p>
            </div>
            <div class="requirement">
              <p class="requirement-label">Timeline</p>
              <p class="mb-0">{{ selectedTender.timeline || 'No timeline provided.' }}</p>
            </div>
            <div class="requirement requirement--full">
              <p class="requirement-label">Required items &amp; documents</p>
              <ul class="requirement-list" *ngIf="selectedTender.requiredDocuments?.length; else noDocuments">
                <li *ngFor="let doc of selectedTender.requiredDocuments">{{ doc }}</li>
              </ul>
              <ng-template #noDocuments>
                <p class="mb-0">No supporting documents are specified for this tender.</p>
              </ng-template>
            </div>
          </div>

          <div class="d-flex justify-content-end mt-3">
            <button type="button" class="btn btn-primary" (click)="proceedToBid()">Next: Fill bid form</button>
          </div>
        </div>

        <div class="bid-panel">
          <div class="bid-panel__header">
            <div>
              <p class="detail-label mb-1">Submit your bid</p>
              <h4 class="bid-panel__title mb-0">Provide commercial and delivery details</h4>
            </div>
            <div class="badge badge-soft-success">{{ getRemainingDays(selectedTender.submissionDeadline) }} days left</div>
          </div>

          <div class="requirements-reminder">
            <div>
              <p class="detail-label mb-1">Requirements reminder</p>
              <h5 class="mb-1">Confirm your proposal covers all needs</h5>
              <p class="text-muted mb-0">
                These are the items requested for this tender. Please ensure your bid aligns with each requirement before
                submitting.
              </p>
            </div>
            <div class="requirements-reminder__list">
              <div class="requirements-reminder__item">
                <span class="requirement-chip">Scope</span>
                <p class="mb-0">{{ selectedTender.scope || 'No scope provided.' }}</p>
              </div>
              <div class="requirements-reminder__item">
                <span class="requirement-chip">Technical</span>
                <p class="mb-0">{{ selectedTender.technicalSpecification || 'No technical specification provided.' }}</p>
              </div>
              <div class="requirements-reminder__item">
                <span class="requirement-chip">Deliverables</span>
                <p class="mb-0">{{ selectedTender.deliverables || 'No deliverables listed.' }}</p>
              </div>
              <div class="requirements-reminder__item">
                <span class="requirement-chip">Timeline</span>
                <p class="mb-0">{{ selectedTender.timeline || 'No timeline provided.' }}</p>
              </div>
              <div class="requirements-reminder__item">
                <span class="requirement-chip">Items &amp; documents</span>
                <ul class="requirement-list" *ngIf="selectedTender.requiredDocuments?.length; else noBidDocuments">
                  <li *ngFor="let doc of selectedTender.requiredDocuments">{{ doc }}</li>
                </ul>
                <ng-template #noBidDocuments>
                  <p class="mb-0">No supporting documents are specified for this tender.</p>
                </ng-template>
              </div>
              <div class="requirements-reminder__item">
                <span class="requirement-chip">Input data</span>
                <ul class="requirement-list" *ngIf="selectedTender.requiredInputs?.length; else noInputRequirements">
                  <li *ngFor="let input of selectedTender.requiredInputs">{{ input }}</li>
                </ul>
                <ng-template #noInputRequirements>
                  <p class="mb-0">No special input data is required beyond the bid form.</p>
                </ng-template>
              </div>
            </div>
          </div>

          <form #bidForm="ngForm" novalidate (ngSubmit)="submitBid(bidForm)" id="inline-bid-form">
            <div class="row g-3" id="bid-basics">
              <div class="col-12 col-md-6">
                <label class="form-label" for="bidAmount">Bid amount</label>
                <div class="input-group">
                  <span class="input-group-text">{{ bidRequest.currency }}</span>
                  <input
                    id="bidAmount"
                    name="bidAmount"
                    type="number"
                    class="form-control"
                    required
                    min="0.01"
                    step="0.01"
                    [(ngModel)]="bidRequest.bidAmount"
                  />
                </div>
                <div class="form-text text-danger" *ngIf="bidForm.submitted && bidForm.controls['bidAmount']?.invalid">
                  Bid amount is required.
                </div>
              </div>

              <div class="col-12 col-md-6">
                <label class="form-label" for="expectedDeliveryDate">Expected delivery date</label>
                <input
                  id="expectedDeliveryDate"
                  name="expectedDeliveryDate"
                  type="date"
                  class="form-control"
                  required
                  [(ngModel)]="bidRequest.expectedDeliveryDate"
                />
                <div
                  class="form-text text-danger"
                  *ngIf="bidForm.submitted && bidForm.controls['expectedDeliveryDate']?.invalid"
                >
                  Delivery date is required.
                </div>
              </div>

              <div class="col-12">
                <label class="form-label" for="proposalSummary">Technical &amp; commercial overview</label>
                <textarea
                  id="proposalSummary"
                  name="proposalSummary"
                  class="form-control"
                  rows="4"
                  required
                  placeholder="Summarize your approach, delivery plan, and key commercial terms"
                  [(ngModel)]="bidRequest.proposalSummary"
                ></textarea>
                <div class="form-text text-danger" *ngIf="bidForm.submitted && bidForm.controls['proposalSummary']?.invalid">
                  A brief proposal summary is required.
                </div>
              </div>
            </div>

            <div class="row g-3 mt-2">
              <div class="col-12" *ngIf="bidRequest.documents?.length" id="bid-documents">
                <div class="section-label d-flex align-items-center justify-content-between">
                  <span class="form-label mb-0">Required documents</span>
                  <small class="text-muted">Upload a file for each required item.</small>
                </div>
                <div class="requirement-doc-list">
                  <div class="requirement-doc" *ngFor="let doc of bidRequest.documents; let i = index">
                    <label class="form-label" [for]="'doc-' + i">{{ doc.name }}</label>
                    <input
                      class="form-control"
                      type="file"
                      accept="application/pdf,image/*,.doc,.docx,.xlsx,.xls,.zip"
                      required
                      [id]="'doc-' + i"
                      [name]="'doc-file-' + i"
                      (change)="onDocumentSelected($event, doc, bidForm)"
                    />
                    <input
                      type="hidden"
                      [name]="'doc-content-' + i"
                      required
                      [(ngModel)]="doc.contentBase64"
                    />
                    <div class="form-text" *ngIf="doc.fileName">Selected: {{ doc.fileName }}</div>
                    <div class="form-text text-danger" *ngIf="bidForm.submitted && !doc.contentBase64">
                      A file is required for this document.
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-12" *ngIf="bidRequest.inputs?.length" id="bid-inputs">
                <div class="section-label d-flex align-items-center justify-content-between">
                  <span class="form-label mb-0">Required input data</span>
                  <small class="text-muted">Answer the tender-specific inputs before submitting.</small>
                </div>
                <div class="requirement-input-list">
                  <div class="requirement-input" *ngFor="let input of bidRequest.inputs; let i = index">
                    <label class="form-label" [for]="'input-' + i">{{ input.name }}</label>
                    <textarea
                      class="form-control"
                      rows="2"
                      required
                      [id]="'input-' + i"
                      [name]="'input-' + i"
                      placeholder="Provide the requested input"
                      [(ngModel)]="input.value"
                    ></textarea>
                    <div class="form-text text-danger" *ngIf="bidForm.submitted && bidForm.controls['input-' + i]?.invalid">
                      This response is required.
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-12" id="bid-submit">
                <label class="form-label" for="notes">Internal notes (optional)</label>
                <textarea
                  id="notes"
                  name="notes"
                  class="form-control"
                  rows="2"
                  placeholder="Share clarifications, assumptions, or attachment references"
                  [(ngModel)]="bidRequest.notes"
                ></textarea>
              </div>
            </div>

            <div class="bid-panel__footer" *ngIf="bidSuccess || bidError">
              <div class="alert alert-success" *ngIf="bidSuccess">{{ bidSuccess }}</div>
              <div class="alert alert-danger" *ngIf="bidError">{{ bidError }}</div>
            </div>

            <div class="bid-panel__actions">
              <button type="submit" class="btn btn-success" [disabled]="bidSubmitting || bidForm.invalid">
                <span *ngIf="bidSubmitting" class="spinner-border spinner-border-sm me-2" aria-hidden="true"></span>
                Submit bid
              </button>
              <button type="button" class="btn btn-outline-secondary" (click)="bidForm.resetForm(bidRequest)" [disabled]="bidSubmitting">
                Clear form
              </button>
            </div>
          </form>
        </div>
      </div>

      <ng-template #noSelection>
        <div class="tender-details__placeholder">
          <h4 class="mb-2">Select a tender to review and submit your bid</h4>
          <p class="text-muted mb-0">Choose a tender on the left to see requirements and share your proposal details.</p>
        </div>
      </ng-template>
    </div>
  </div>
</div>
