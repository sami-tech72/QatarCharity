<div class="bid-evaluation">
  <div class="page-header d-flex align-items-center justify-content-between gap-3">
    <div>
      <h1 class="mb-1">Bid Evaluation</h1>
      <p class="text-muted mb-0">Review supplier submissions and log your decisions.</p>
    </div>
    <div class="search-box">
      <label class="form-label mb-1" for="bidSearch">Search</label>
      <input
        id="bidSearch"
        type="text"
        class="form-control"
        placeholder="Search by RFx or status"
        [formControl]="searchControl"
      />
    </div>
  </div>

  <div class="summary-grid">
    <div class="summary-card">
      <div class="label">Total Bids</div>
      <div class="value">{{ summary.total }}</div>
    </div>
    <div class="summary-card">
      <div class="label">Under Review</div>
      <div class="value text-info">{{ summary.underReview }}</div>
    </div>
    <div class="summary-card">
      <div class="label">Accepted</div>
      <div class="value text-success">{{ summary.approved }}</div>
    </div>
    <div class="summary-card">
      <div class="label">Pending Review</div>
      <div class="value text-warning">{{ summary.pendingReview }}</div>
    </div>
  </div>

  <section class="card list-card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h2 class="h5 mb-1">All Bids</h2>
          <p class="text-muted mb-0">Showing {{ bids.length }} of {{ total }} submissions.</p>
        </div>
        <div *ngIf="loading" class="text-muted small">Loading...</div>
      </div>

      <div *ngIf="!bids.length && !loading" class="empty-state">No bids have been submitted yet.</div>

      <div class="table-responsive" *ngIf="bids.length">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>Bid Number</th>
              <th>Supplier Name</th>
              <th>RFx</th>
              <th>Bid Amount</th>
              <th>Status</th>
              <th>Reviews</th>
              <th>Submitted</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let bid of bids; trackBy: trackByBidId" [class.table-active]="selectedBid?.id === bid.id">
              <td>
                <div class="fw-semibold">{{ bid.referenceNumber }}</div>
                <div class="text-muted small">{{ bid.id }}</div>
              </td>
              <td>
                <div class="fw-semibold">{{ bid.submittedBy }}</div>
                <div class="text-muted small">{{ bid.proposalSummary }}</div>
              </td>
              <td>
                <div class="fw-semibold">{{ bid.title }}</div>
                <div class="text-muted small">{{ bid.rfxId }}</div>
              </td>
              <td>
                <div class="fw-semibold">{{ bid.bidAmount | number: '1.0-2' }} {{ bid.currency }}</div>
                <div class="text-muted small">Delivery: {{ bid.expectedDeliveryDate | date: 'mediumDate' }}</div>
              </td>
              <td>
                <span class="badge" [ngClass]="statusBadgeClass(bid.evaluationStatus)">{{ bid.evaluationStatus }}</span>
              </td>
              <td>
                <div class="fw-semibold">{{ bid.reviews?.length || 0 }} review(s)</div>
                <div class="text-muted small" *ngIf="bid.reviews?.[0]">
                  Last updated {{ bid.reviews[0].reviewedAtUtc | date: 'mediumDate' }}
                </div>
                <div class="text-muted small" *ngIf="reviewerNames(bid).length">
                  Reviewers: {{ reviewerNames(bid).join(', ') }}
                </div>
              </td>
              <td>{{ bid.submittedAtUtc | date: 'mediumDate' }}</td>
              <td class="text-end">
                <div class="btn-group" role="group">
                  <button type="button" class="btn btn-light btn-sm" (click)="selectBid(bid)">
                    View
                  </button>
                  <button type="button" class="btn btn-success btn-sm" (click)="openReviewModal(bid)">
                    Review
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <div class="app-modal-backdrop" *ngIf="reviewModalOpen" (click)="closeReviewModal()"></div>
  <div class="app-modal" *ngIf="reviewModalOpen">
    <div class="app-modal-dialog app-modal-dialog--wide">
      <div class="modal-content app-modal-content">
        <div class="modal-header app-modal-header align-items-start gap-3 flex-wrap">
          <div class="d-flex flex-column gap-1">
            <div class="text-muted small">RFx {{ selectedBid?.referenceNumber }}</div>
            <h2 class="h5 mb-0">{{ selectedBid?.title }}</h2>
            <div class="text-muted">Submitted by {{ selectedBid?.submittedBy }} on {{ selectedBid?.submittedAtUtc | date: 'medium' }}</div>
          </div>
          <div class="d-flex align-items-center gap-3">
            <span class="badge" [ngClass]="statusBadgeClass(selectedBid?.evaluationStatus ?? '')">
              {{ selectedBid?.evaluationStatus }}
            </span>
            <button type="button" class="btn btn-icon btn-sm btn-light" aria-label="Close" (click)="closeReviewModal()">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
        </div>

        <div class="modal-body app-modal-body">
          <div class="mb-4">
            <div class="fw-semibold">Proposal summary</div>
            <p class="text-muted mb-2">{{ selectedBid?.proposalSummary }}</p>
            <div class="fw-semibold">Notes</div>
            <p class="text-muted mb-0">{{ selectedBid?.notes || 'No additional notes provided.' }}</p>
          </div>

          <div class="mb-4">
            <div class="d-flex align-items-center justify-content-between gap-3 mb-2 flex-wrap">
              <div class="fw-semibold mb-0">Review history</div>
              <span class="badge badge-light-primary">{{ selectedBid?.reviews?.length || 0 }} recorded review(s)</span>
            </div>

            <p class="text-muted small mb-3">
              Each reviewer logs their own decision; entries below are ordered from newest to oldest so you can quickly see the
              latest consensus.
            </p>

            <div class="reviewer-overview" *ngIf="reviewerNames(selectedBid).length">
              <div class="text-muted small">Reviewers involved</div>
              <div class="chip-group">
                <span class="chip" *ngFor="let reviewer of reviewerNames(selectedBid)">{{ reviewer }}</span>
              </div>
            </div>

            <div *ngIf="selectedBid?.reviews?.length; else noReviews" class="review-history">
              <div class="review-history__item" *ngFor="let review of selectedBid?.reviews; trackBy: trackByReview">
                <div class="d-flex justify-content-between align-items-start gap-3 flex-wrap">
                  <div>
                    <div class="fw-semibold">{{ review.reviewerName }}</div>
                    <div class="text-muted small">Reviewed {{ review.reviewedAtUtc | date: 'medium' }}</div>
                  </div>
                  <span class="badge" [ngClass]="statusBadgeClass(review.status)">{{ review.status }}</span>
                </div>
                <div class="text-muted mt-2" *ngIf="review.notes">{{ review.notes }}</div>
              </div>
            </div>
            <ng-template #noReviews>
              <div class="placeholder">No reviews have been submitted for this bid yet.</div>
            </ng-template>
          </div>

          <form [formGroup]="reviewForm" (ngSubmit)="submitReview()" class="review-form">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label" for="status">Decision</label>
                <select id="status" class="form-select" formControlName="status">
                  <option *ngFor="let status of statuses" [value]="status">{{ status }}</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label" for="reviewed">Reviewed by</label>
                <div class="form-control-plaintext fw-semibold">
                  {{ selectedBid?.evaluatedBy || 'Not reviewed yet' }}
                </div>
                <div class="text-muted small" *ngIf="selectedBid?.evaluatedAtUtc">
                  Updated {{ selectedBid?.evaluatedAtUtc | date: 'medium' }}
                </div>
              </div>
            </div>

            <div class="mt-3">
              <label class="form-label" for="reviewNotes">Review notes</label>
              <textarea
                id="reviewNotes"
                rows="4"
                class="form-control"
                placeholder="Document your evaluation, strengths and risks."
                formControlName="reviewNotes"
              ></textarea>
            </div>

            <div class="modal-footer app-modal-footer px-0 pt-5 justify-content-end gap-2">
              <button type="button" class="btn btn-light" (click)="closeReviewModal()">Cancel</button>
              <button type="submit" class="btn btn-primary" [disabled]="submitting || reviewForm.invalid">
                {{ submitting ? 'Saving...' : 'Save Review' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
