<div class="bid-evaluation">
  <div class="page-header d-flex align-items-center justify-content-between gap-3">
    <div>
      <h1 class="mb-1">Bid Evaluation</h1>
      <p class="text-muted mb-0">Review supplier submissions and log your decisions.</p>
    </div>
    <div class="search-box">
      <label class="form-label mb-1" for="bidSearch">Search</label>
      <input
        id="bidSearch"
        type="text"
        class="form-control"
        placeholder="Search by RFx or status"
        [formControl]="searchControl"
      />
    </div>
  </div>

  <div class="grid">
    <section class="card list-card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h2 class="h5 mb-1">Submitted bids</h2>
            <p class="text-muted mb-0">Showing {{ bids.length }} of {{ total }} submissions.</p>
          </div>
          <div *ngIf="loading" class="text-muted small">Loading...</div>
        </div>

        <div *ngIf="!bids.length && !loading" class="empty-state">No bids have been submitted yet.</div>

        <div class="table-responsive" *ngIf="bids.length">
          <table class="table align-middle">
            <thead>
              <tr>
                <th>RFx</th>
                <th>Supplier</th>
                <th>Bid</th>
                <th>Submitted</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr
                *ngFor="let bid of bids; trackBy: trackByBidId"
                (click)="selectBid(bid)"
                [class.table-active]="selectedBid?.id === bid.id"
              >
                <td>
                  <div class="fw-semibold">{{ bid.referenceNumber }}</div>
                  <div class="text-muted small">{{ bid.title }}</div>
                </td>
                <td>{{ bid.submittedBy }}</td>
                <td>
                  <div class="fw-semibold">{{ bid.bidAmount | number: '1.0-2' }} {{ bid.currency }}</div>
                  <div class="text-muted small">Delivery: {{ bid.expectedDeliveryDate | date: 'mediumDate' }}</div>
                </td>
                <td>{{ bid.submittedAtUtc | date: 'medium' }}</td>
                <td>
                  <span class="badge" [ngClass]="statusBadgeClass(bid.evaluationStatus)">{{ bid.evaluationStatus }}</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="card detail-card">
      <div class="card-body" *ngIf="selectedBid; else selectPrompt">
        <div class="d-flex justify-content-between align-items-start gap-3 flex-wrap">
          <div>
            <div class="text-muted small">RFx {{ selectedBid?.referenceNumber }}</div>
            <h2 class="h5 mb-1">{{ selectedBid?.title }}</h2>
            <div class="text-muted">Submitted by {{ selectedBid?.submittedBy }} on {{ selectedBid?.submittedAtUtc | date: 'medium' }}</div>
          </div>
          <span class="badge" [ngClass]="statusBadgeClass(selectedBid?.evaluationStatus ?? '')">
            {{ selectedBid?.evaluationStatus }}
          </span>
        </div>

        <hr />

        <div class="mb-3">
          <div class="fw-semibold">Proposal summary</div>
          <p class="text-muted mb-2">{{ selectedBid?.proposalSummary }}</p>
          <div class="fw-semibold">Notes</div>
          <p class="text-muted mb-0">{{ selectedBid?.notes || 'No additional notes provided.' }}</p>
        </div>

        <form [formGroup]="reviewForm" (ngSubmit)="submitReview()" class="review-form">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label" for="status">Decision</label>
              <select id="status" class="form-select" formControlName="status">
                <option *ngFor="let status of statuses" [value]="status">{{ status }}</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label" for="reviewed">Reviewed by</label>
              <div class="form-control-plaintext fw-semibold">
                {{ selectedBid?.evaluatedBy || 'Not reviewed yet' }}
              </div>
              <div class="text-muted small" *ngIf="selectedBid?.evaluatedAtUtc">
                Updated {{ selectedBid?.evaluatedAtUtc | date: 'medium' }}
              </div>
            </div>
          </div>

          <div class="mt-3">
            <label class="form-label" for="reviewNotes">Review notes</label>
            <textarea
              id="reviewNotes"
              rows="4"
              class="form-control"
              placeholder="Document your evaluation, strengths and risks."
              formControlName="reviewNotes"
            ></textarea>
          </div>

          <div class="d-flex justify-content-end gap-2 mt-4">
            <button type="submit" class="btn btn-primary" [disabled]="submitting || reviewForm.invalid">
              {{ submitting ? 'Saving...' : 'Save Review' }}
            </button>
          </div>
        </form>
      </div>

      <ng-template #selectPrompt>
        <div class="placeholder">
          <h3 class="h5 mb-2">Select a bid to review</h3>
          <p class="text-muted mb-0">Choose a submission from the list to view its details and provide feedback.</p>
        </div>
      </ng-template>
    </section>
  </div>
</div>
