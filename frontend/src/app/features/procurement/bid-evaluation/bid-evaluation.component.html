<div class="page-header">
  <div>
    <h2 class="page-title">Bid Evaluation</h2>
    <p class="text-muted mb-0">Review and evaluate supplier bids</p>
  </div>

  <form class="search" (submit)="$event.preventDefault()">
    <i class="ki-duotone ki-magnifier fs-3"></i>
    <input type="text" placeholder="Search bids" [formControl]="searchControl" />
    <button type="button" class="btn btn-light" (click)="searchControl.setValue('')" [disabled]="!searchControl.value">
      Clear
    </button>
  </form>
</div>

<div class="row g-4 mb-6">
  <div class="col-xxl-3 col-md-6">
    <div class="summary-card">
      <div class="summary-label">Total Bids</div>
      <div class="summary-value">{{ statusTotals.total }}</div>
    </div>
  </div>
  <div class="col-xxl-3 col-md-6">
    <div class="summary-card">
      <div class="summary-label">Under Review</div>
      <div class="summary-value">{{ statusTotals.underReview }}</div>
    </div>
  </div>
  <div class="col-xxl-3 col-md-6">
    <div class="summary-card">
      <div class="summary-label">Accepted</div>
      <div class="summary-value">{{ statusTotals.accepted }}</div>
    </div>
  </div>
  <div class="col-xxl-3 col-md-6">
    <div class="summary-card">
      <div class="summary-label">Pending Review</div>
      <div class="summary-value">{{ statusTotals.pending }}</div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-body p-6">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-5">
      <div>
        <div class="card-subtitle text-muted">All Bids</div>
        <h4 class="mb-0">Review and evaluate supplier bids</h4>
      </div>
      <span class="text-muted fw-semibold">
        {{ isCommitteeUser ? 'Showing bids assigned to your committee' : 'Showing all supplier bids' }}
      </span>
    </div>

    <div *ngIf="isCommitteeUser" class="alert alert-warning d-flex align-items-center p-5 mb-5">
      <i class="ki-duotone ki-abstract-41 fs-2hx text-warning me-4"></i>
      <div class="d-flex flex-column">
        <h4 class="mb-1 text-dark">Committee view</h4>
        <span class="text-gray-700">Only bids for RFx records assigned to your committee role are listed.</span>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr class="text-muted fw-semibold text-uppercase">
            <th>Bid No</th>
            <th>Supplier</th>
            <th>Submitted By</th>
            <th>RFx</th>
            <th>Bid Amount</th>
            <th>Status</th>
            <th>Reviews</th>
            <th>Submitted</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="loading">
            <td colspan="8" class="text-center py-10 text-muted">
              <span class="spinner-border spinner-border-sm align-middle me-2"></span>
              Loading bids for evaluation...
            </td>
          </tr>
          <tr *ngIf="!loading && !bids.length">
            <td colspan="8" class="text-center py-10 text-muted">{{ emptyStateMessage }}</td>
          </tr>
          <tr *ngFor="let bid of bids; trackBy: trackByBidId" class="align-middle">
            <td class="fw-bold text-gray-900">{{ getBidNumber(bid) }}</td>
            <td>
              <div class="fw-semibold text-gray-900">{{ bid.supplierName }}</div>
              <div class="text-muted">{{ bid.notes || 'No notes provided' }}</div>
            </td>
            <td>
              <div class="fw-semibold text-gray-900">{{ bid.submittedByName }}</div>
              <div class="text-muted">User ID: {{ bid.submittedByUserId }}</div>
            </td>
            <td>
              <div class="fw-semibold text-gray-900">{{ bid.rfxTitle }}</div>
              <div class="text-muted">{{ bid.rfxReferenceNumber }}</div>
            </td>
            <td class="fw-bold text-gray-900">{{ bid.bidAmount | currency: bid.currency : 'symbol-narrow' : '1.0-0' }}</td>
            <td>
              <span class="badge" [ngClass]="getStatusDisplay(bid).cssClass">{{ getStatusDisplay(bid).label }}</span>
            </td>
            <td>
              <div class="d-flex align-items-center gap-2 flex-wrap">
                <span class="review-chip neutral" title="Total reviews">
                  <i class="ki-duotone ki-eye fs-4 me-1"></i>
                  {{ bid.reviews?.length || 0 }}
                </span>
                <span class="review-chip success" title="Approvals">
                  <i class="ki-duotone ki-check fs-4 me-1"></i>
                  {{ getReviewTotals(bid).approved }}
                </span>
                <span class="review-chip danger" title="Rejections">
                  <i class="ki-duotone ki-cross-circle fs-4 me-1"></i>
                  {{ getReviewTotals(bid).rejected }}
                </span>
              </div>
              <div class="text-muted small" *ngIf="getReviewDecision(bid) as decision">
                You marked this bid as <strong>{{ decision === 'approved' ? 'good' : 'not good' }}</strong>.
              </div>
            </td>
            <td>{{ bid.submittedAtUtc | date: 'mediumDate' }}</td>
            <td class="text-end">
              <button
                type="button"
                class="btn btn-icon btn-light btn-sm me-1"
                title="Mark under review"
                [disabled]="reviewing.has(bid.id)"
                (click)="submitReview(bid, 'review')"
              >
                <i class="ki-duotone ki-eye"></i>
              </button>
              <button
                type="button"
                class="btn btn-icon btn-light-success btn-sm me-1"
                title="Mark as good"
                [disabled]="reviewing.has(bid.id)"
                (click)="submitReview(bid, 'approved')"
              >
                <i class="ki-duotone ki-check"></i>
              </button>
              <button
                type="button"
                class="btn btn-icon btn-light-danger btn-sm"
                title="Mark as not good"
                [disabled]="reviewing.has(bid.id)"
                (click)="submitReview(bid, 'rejected')"
              >
                <i class="ki-duotone ki-cross-circle"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
