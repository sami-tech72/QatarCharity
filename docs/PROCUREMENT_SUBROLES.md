# Procurement sub-role claims

Procurement permissions are driven by claims on the procurement user rather than a fixed list of sub-role names. Each claim uses the type `procurement_sub_role` and a value in the format:

```
<RoleName>|view,create,update,delete
```

* `RoleName` can be any string (for example, `ProcurementReviewer` or `ContractApprover`).
* The permission segment is a comma-separated list containing any combination of `view`, `create`, `update`, and `delete`.
* If the permission segment is omitted (just `RoleName`), built-in defaults are applied for the predefined names (`ProcurementViewer`, `ProcurementContributor`, `ProcurementManager`).

## Where to add sub-roles and permissions (backend)

Add procurement sub-roles as claims on the procurement user. The canonical place during local development is the seeder (`src/Persistence/Seed/DatabaseSeeder.cs`), inside `EnsureProcurementUser`. It builds a dictionary of sub-role names and permission sets, then formats each claim with `ProcurementPermissionCalculator.ToClaimValue`:

```csharp
var defaultSubRoles = new Dictionary<string, ProcurementPermissionSet>
{
    [ProcurementSubRoles.Manager] = new(CanView: true, CanCreate: true, CanUpdate: true, CanDelete: true),
    ["ProcurementReviewer"] = new(CanView: true, CanUpdate: true),
};

await userManager.AddClaimAsync(
    procurementUser,
    new Claim(CustomClaimTypes.ProcurementSubRole, ProcurementPermissionCalculator.ToClaimValue("ProcurementReviewer", defaultSubRoles["ProcurementReviewer"])));
```

When creating or editing users elsewhere (e.g., in an admin API), add the same claim type (`procurement_sub_role`) with a value generated by `ToClaimValue`. The backend login response will automatically parse, merge, and return the resulting `procurementSubRoles` and aggregated `procurementPermissions`.

### Manual assignment endpoint

You can also add or update a procurement user's sub-role through the dedicated endpoint:

```
POST /api/procurement/users/{userId}/sub-roles
{
  "name": "ProcurementReviewer",
  "canView": true,
  "canCreate": false,
  "canUpdate": true,
  "canDelete": false
}
```

* Requires the caller to be `Admin` or `Procurement`.
* If a claim for the same sub-role name already exists, it is replaced.
* The response returns the updated sub-role grants and the combined permission set for the user.

## Where the frontend reads and enforces permissions

1. `frontend/src/app/core/services/auth.service.ts` reads `procurementSubRoles` and `procurementPermissions` from the login response and stores them in the session model.
2. Routes under `frontend/src/app/features/procurement/procurement.routes.ts` declare the required permission bit in `data.procurementPermission` (e.g., `view`, `create`, `update`, `delete`).
3. The guard `frontend/src/app/core/guards/auth.guard.ts` allows or blocks navigation based on those bits. Because `procurementSubRoles` is an open array of strings, you can invent new sub-role names in backend claims without changing the frontendâ€”only the permissions determine access.

### Manual assignment screen

`frontend/src/app/features/procurement/settings/procurement-settings.component.ts` now includes a simple form that calls `POST /api/procurement/users/{userId}/sub-roles` so you can add or edit sub-roles and permissions without changing code. Provide the user's ID, sub-role name, and the view/create/update/delete flags; the screen will show the updated grants and combined permissions returned by the backend.
